// SPDX-License-Identifier: PMPL-1.0-or-later
= typeql-experimental (VQL-dt++)
Jonathan D.A. Jewell <j.d.a.jewell@open.ac.uk>
:description: Experimental type-theoretic extensions to VQL
:toc: macro
:icons: font

== Overview

**typeql-experimental** explores six advanced type-theoretic extensions to the
VeriSim Query Language (VQL), building on the VQL-dt dependent type system
(~35% wired in VeriSimDB). Rather than bolting these onto the production
codebase, this is a standalone exploration space within the `nextgen-databases`
monorepo.

The six extensions are:

[cols="1,2,2"]
|===
|Extension |VQL++ Syntax |Idris2 Mechanism

|Linear Types
|`CONSUME AFTER N USE`
|QTT quantity `1` on `Connection`

|Session Types
|`WITH SESSION protocol`
|`Session : SessionState -> Type` indexed type

|Effect Systems
|`EFFECTS { Read, Write }`
|Effect set with subsumption proofs

|Modal Types
|`IN TRANSACTION`
|Box types indexed by world/scope

|Proof-Carrying Code
|`PROOF ATTACHED theorem`
|`ProvedResult` sigma type

|Quantitative Type Theory
|`USAGE LIMIT n`
|Bounded resource tracking via QTT
|===

== Status

[cols="2,1,3"]
|===
|Component |Status |Notes

|Idris2 Kernel (9 modules)
|PASS
|All type-check with `%default total`, zero `believe_me`

|Zig FFI Bridge (5 tests)
|PASS
|`zig build test` clean on Zig 0.15.2

|ReScript Parser
|Written
|Not yet build-tested (needs rescript-legacy toolchain)

|Grammar Specification
|Complete
|Delta EBNF extending VQL v3.0

|Examples (7 .vqlpp files)
|Complete
|All 6 extensions + combined maximal query

|Documentation
|Complete
|README, DESIGN doc, type system spec, examples doc
|===

== Architecture: Dual-Language Split

* **Idris2** (`src/abi/`) — Type system kernel. Idris2 already has QTT
  (quantitative type theory) built in, making linear types and resource
  accounting native rather than encoded. These modules serve as _formal
  specification AND proof checker_.

* **ReScript** (`src/parser/`) — Parser and surface syntax. Consistent with
  existing VQL parser patterns in VeriSimDB. Handles parsing and surface-level
  validation.

* **Zig** (`ffi/zig/`) — C-compatible FFI bridge. Exposes the type checker's
  validation functions to non-Idris2 consumers via the hyperpolymath ABI/FFI
  standard (Idris2 defines ABI, Zig implements FFI).

For this experimental project, the two layers operate independently — Idris2
proves properties, ReScript parses queries — without requiring runtime interop.

== Building

[source,bash]
----
# Type-check all Idris2 modules
just check

# Run Zig FFI tests
just test-zig

# ReScript parser build (when toolchain available)
just build-parser

# Run all tests
just test

# Verify no banned patterns
just audit
----

=== Direct Commands

[source,bash]
----
# Idris2 type-check (requires Idris2 >= 0.8.0)
idris2 --typecheck typeql-experimental.ipkg

# Zig FFI tests (requires Zig 0.15.2)
cd ffi/zig && zig build test

# Banned pattern scan (should return nothing)
grep -rn 'believe_me\|assert_total\|assert_smaller' src/abi/
----

== Grammar

The query language extends VQL v3.0 with six new optional clauses appended
after the standard query. See `docs/vql-dtpp-grammar.ebnf` for the delta
grammar. No keyword conflicts — all new clause keywords are disjoint from
VQL's 60+ reserved keywords.

Example (maximal query using all 6 extensions):

[source,vql]
----
SELECT GRAPH, DOCUMENT
FROM HEXAD 550e8400-e29b-41d4-a716-446655440000
WHERE FULLTEXT CONTAINS "climate change"
PROOF EXISTENCE(VerifyExists) AND CITATION(VerifyCitation)
CONSUME AFTER 1 USE
WITH SESSION ReadOnlyProtocol
EFFECTS { Read, Cite }
IN TRANSACTION Committed
PROOF ATTACHED IntegrityTheorem
USAGE LIMIT 100
----

== Idris2 Modules

[cols="2,4"]
|===
|Module |Purpose

|`Core.idr`
|Foundation types: Modality, HexadRef, EffectLabel, Usage, TQLError, Subset

|`Linear.idr`
|Linear types via QTT: `LinConn`, `useConn`, `closeConn`

|`Session.idr`
|Session state machines: `SessionImpl`, `auth`, `beginTx`, `query`, `commit`, `close`

|`Effects.idr`
|Effect sets with subsumption: `EffectSet`, `HasEffect`, `Subsumes`

|`Modal.idr`
|Modal box types: `Box`, `InScope`, `unbox`, `marshal`, `CanRead`, `CanWrite`

|`ProofCarrying.idr`
|Theorem attachment: `ProvedResult`, `MultiProved`, `Verifier`

|`Quantitative.idr`
|Bounded resources: `BoundedResource`, `consume`, `split`, `merge`

|`Checker.idr`
|Unified checker: `ExtensionAnnotations`, `validate`

|`Proofs.idr`
|Cross-cutting proofs: subset transitivity, subsumption monotonicity, etc.
|===

== Implementation Notes

Several issues were discovered and resolved during implementation:

* **`idris2 --typecheck` vs `--check`**: For ipkg files, `--typecheck` is the
  correct flag. `--check` treats the ipkg as an Idris2 source file.
* **Effect subsumption direction**: `Subsumes declared actual` means "actual is
  a subset of declared" (i.e., `Subset actual declared`). The naive direction
  was backwards.
* **Erased implicits**: Quantity-0 implicits cannot be pattern-matched at
  runtime. The `hasUses` function was removed; the type system itself
  distinguishes `Available` from `Depleted`.
* **Zig 0.15.2 API**: `addStaticLibrary` was removed. The build uses
  `addModule` + `addTest(.root_module)` instead.
* **Non-associative helpers**: `andCheck` requires explicit nested calls, not
  backtick infix chaining.

== Licence

PMPL-1.0-or-later
